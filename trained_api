from flask import Flask, request, jsonify, send_from_directory, render_template_string
import os
import threading
import logging
from train_lora_test_peter import train_lora

app = Flask(__name__, static_folder="static")

@app.route("/")
def home():
    return send_from_directory("static", "index.html")

@app.route("/train", methods=["POST"])
def trigger_training():
    try:
        data = request.get_json()
        zip_path = data.get("zip_path")
        output_dir = data.get("output_dir")
        action = data.get("action", "clapping")

        if not zip_path or not output_dir:
            return jsonify({"error": "zip_path and output_dir are required"}), 400

        if not os.path.exists(zip_path):
            return jsonify({"error": f"Zip file not found at {zip_path}"}), 404

        os.makedirs(output_dir, exist_ok=True)

        thread = threading.Thread(target=train_lora, args=(zip_path, output_dir, action))
        thread.start()

        return jsonify({
            "status": "training_started",
            "message": f"Training started for action '{action}'."
        })

    except Exception as e:
        logging.exception("Training failed")
        return jsonify({"error": str(e)}), 500

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8000, debug=True)
